<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>–ö–∏–±–ª–∞ –ö–æ–º–ø–∞—Å</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: linear-gradient(120deg, #0d3547 0, #47d6ae 100%);
      font-family: 'Rubik', Arial, Helvetica, sans-serif;
    }
    .top-bar {
      background: #166c43;
      color: #fff;
      padding: 14px 0 14px 0;
      text-align: center;
      font-size: 1.35em;
      letter-spacing: 0.05em;
    }
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 94vh;
    }
    .compass-wrapper {
      margin-top: 30px;
      width: 320px;
      height: 320px;
      position: relative;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .compass-img {
      width: 100%;
      height: 100%;
      display: block;
      position: absolute;
      top: 0; left: 0;
      z-index: 1;
      pointer-events: none;
    }
    .arrow {
      width: 90px;
      height: 90px;
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -70%);
      z-index: 2;
      pointer-events: none;
    }
    .status {
      margin-top: 24px;
      font-size: 1.09em;
      color: #1c515f;
      text-align: center;
      padding: 10px;
      background: rgba(255,255,255,0.85);
      border-radius: 11px;
      min-width: 240px;
      min-height: 2.2em;
    }
    .kaaba {
      position: absolute;
      width: 46px; height: 46px;
      left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      z-index: 3;
      pointer-events: none;
      filter: drop-shadow(0 2px 8px #111a);
    }
    @media (max-width: 480px) {
      .compass-wrapper {width: 90vw; height: 90vw;}
      .kaaba {width:11vw;height:11vw;}
      .arrow {width:22vw;height:22vw;}
    }
  </style>
</head>
<body>
  <div class="top-bar">üß≠ –ö–∏–±–ª–∞-–ö–æ–º–ø–∞—Å</div>
  <div class="container">
    <div class="compass-wrapper">
      <!-- —Ü–∏—Ñ–µ—Ä–±–ª–∞—Ç –∫–æ–º–ø–∞—Å–∞ -->
      <img class="compass-img" src="https://cdn.jsdelivr.net/gh/nazartm/qibla-assets@main/compass2.svg" alt="–ö–æ–º–ø–∞—Å">
      <!-- —Å—Ç—Ä–µ–ª–∫–∞, —É–∫–∞–∑—ã–≤–∞—é—â–∞—è –Ω–∞ –ö–∏–±–ª—É -->
      <img class="arrow" src="https://cdn.jsdelivr.net/gh/nazartm/qibla-assets@main/qibla-arrow.svg" alt="–ö–∏–±–ª–∞">
      <!-- –∏–∫–æ–Ω–∫–∞ –ö–∞–∞–±—ã –ø–æ —Ü–µ–Ω—Ç—Ä—É -->
      <img class="kaaba" src="https://cdn.jsdelivr.net/gh/nazartm/qibla-assets@main/kaaba.png" alt="–ö–∞–∞–±–∞">
    </div>
    <div class="status"> –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ –∫–æ–º–ø–∞—Å... </div>
  </div>
  <script>
    // –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ö–∞–∞–±—ã
    const KAABA = { lat: 21.4225, lng: 39.8262 };
    const statusEl = document.querySelector('.status');
    const arrowEl = document.querySelector('.arrow');
    const compassEl = document.querySelector('.compass-img');

    let userLat = null, userLng = null, qiblaDeg = null;

    function deg2rad(deg){return deg*Math.PI/180;}
    function rad2deg(rad){return rad*180/Math.PI;}
    function getQiblaAngle(lat1, lon1, lat2, lon2) {
        // –í—ã–¥–∞–µ—Ç —É–≥–æ–ª (–∞–∑–∏–º—É—Ç) –æ—Ç "—Å–µ–≤–µ—Ä–∞" (–≥—Ä–∞–¥—É—Å—ã) –¥–æ –ö–∏–±–ª—ã
        let phi1 = deg2rad(lat1), phi2 = deg2rad(lat2), dLon = deg2rad(lon2-lon1);
        let y = Math.sin(dLon)*Math.cos(phi2);
        let x = Math.cos(phi1)*Math.sin(phi2)-Math.sin(phi1)*Math.cos(phi2)*Math.cos(dLon);
        let brng = Math.atan2(y, x);
        return (rad2deg(brng)+360)%360;
    }

    function geoError(err){
      statusEl.textContent = '–û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è: ' + err.message;
    }
    function geoSuccess(pos){
      userLat = pos.coords.latitude;
      userLng = pos.coords.longitude;
      qiblaDeg = getQiblaAngle(userLat, userLng, KAABA.lat, KAABA.lng);
      statusEl.textContent = "–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã. –ö–∞–ª–∏–±—Ä—É–µ–º –∫–æ–º–ø–∞—Å...";
      enableCompass();
    }

    // compassHeading ‚Äì –∫—É–¥–∞ "—Å–º–æ—Ç—Ä–∏—Ç" —Å–µ–≤–µ—Ä (–æ—Ç 0)
    function updateCompass(compassHeading){
      if (qiblaDeg === null) return;
      // —É–≥–æ–ª –º–µ–∂–¥—É "—Å–µ–≤–µ—Ä–æ–º" –∏ –ö–∏–±–ª–æ–π
      let angle = qiblaDeg - compassHeading;
      // –≤—Ä–∞—â–∞–µ–º —Å—Ç—Ä–µ–ª–∫—É
      arrowEl.style.transform = `translate(-50%,-70%) rotate(${angle}deg)`;
      compassEl.style.transform = `rotate(${-compassHeading}deg)`;
      statusEl.innerHTML = `–ü–æ–≤–µ—Ä–Ω–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω —Ç–∞–∫, —á—Ç–æ–±—ã —Å—Ç—Ä–µ–ª–∫–∞ —Å–º–æ—Ç—Ä–µ–ª–∞ –≤–ø–µ—Ä—ë–¥.<br>–£–≥–æ–ª –¥–æ –ö–∏–±–ª—ã:&nbsp;<b>${qiblaDeg.toFixed(1)}¬∞</b>`;
    }

    // iOS —Ç—Ä–µ–±—É–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –≤—Ä—É—á–Ω—É—é
    function enableCompass(){
      if (window.DeviceOrientationEvent) {
        if (typeof(DeviceOrientationEvent.requestPermission)==='function') {
          // iOS
          DeviceOrientationEvent.requestPermission().then(function(response){
            if (response==='granted') subscribeCompass();
            else statusEl.textContent = '–î–æ—Å—Ç—É–ø –∫ –∫–æ–º–ø–∞—Å—É –Ω–µ —Ä–∞–∑—Ä–µ—à—ë–Ω.';
          }).catch(function(e){
            statusEl.textContent = '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞—Ç—á–∏–∫–∞–º: '+e;
          });
        } else {
          // Android/–¥—Ä—É–≥–∏–µ
          subscribeCompass();
        }
      } else {
        statusEl.textContent = '–ö–æ–º–ø–∞—Å –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.';
      }
    }

    function subscribeCompass(){
      window.addEventListener('deviceorientation', function(event){
        let heading;
        if (event.absolute && event.alpha!==null) {
          heading = event.alpha;
        } else if (event.webkitCompassHeading) { // iOS
          heading = event.webkitCompassHeading;
        } else {
          statusEl.textContent = '–ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å —É–≥–æ–ª –∫–æ–º–ø–∞—Å–∞. –ú–æ–∂–µ—Ç, —Ç—Ä–µ–±—É–µ—Ç—Å—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞.';
          return;
        }
        updateCompass(heading);
      }, true);
      statusEl.textContent = '–ü–æ–≤–æ—Ä–∞—á–∏–≤–∞–π—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω ‚Äî –∫–æ–º–ø–∞—Å –∞–∫—Ç–∏–≤–µ–Ω!';
    }

    // –ó–∞–ø—É—Å–∫
    if (location.protocol==='https:') {
      navigator.geolocation.getCurrentPosition(geoSuccess, geoError, {enableHighAccuracy:true});
    } else {
      statusEl.textContent = '–ö–æ–º–ø–∞—Å —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ HTTPS';
    }
  </script>
</body>
</html>
