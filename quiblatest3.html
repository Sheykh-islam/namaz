<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Кибла и Время Намаза</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 2em; }
    #qiblaCompass { margin: 2em auto 1em; width: 200px; height: 200px; position: relative; }
    #arrow {
      width: 0; height: 0; border-left: 20px solid transparent;
      border-right: 20px solid transparent;
      border-bottom: 90px solid #39a845;
      position: absolute; left: 50%; top: 50%;
      transform: translate(-50%, -100%) rotate(0deg);
      transition: transform 0.3s;
      z-index: 2;
    }
    #compassCircle {
      position: absolute; left: 0; top: 0;
      width: 100%; height: 100%;
      border: 4px solid #bbb; border-radius: 50%;
      z-index: 1;
    }
    #status { margin: 1em 0; color: #389; }
    #prayer-times { margin: 2em auto; padding: 1em; display: inline-block; background: #eef; border-radius: 10px; }
    pre { text-align: left; }
  </style>
</head>
<body>
  <h2>Кибла и Время Намаза</h2>
  <div id="qiblaCompass">
    <div id="compassCircle"></div>
    <div id="arrow"></div>
  </div>
  <div id="status">Определяем ваше местоположение...</div>
  <div id="qiblaAngle"></div>
  <div id="prayer-times"></div>
  <script>
    const kaabaLat = 21.4225, kaabaLon = 39.8262;
    let userLat, userLon, qiblaAngle;

    // Haversine Qibla formula
    function getQiblaAngle(lat, lon) {
        let phiK = kaabaLat * Math.PI / 180;
        let lambdaK = kaabaLon * Math.PI / 180;
        let phi = lat * Math.PI / 180;
        let lambda = lon * Math.PI / 180;

        let y = Math.sin(lambdaK - lambda);
        let x = Math.cos(phi) * Math.tan(phiK) - Math.sin(phi) * Math.cos(lambdaK - lambda);

        let theta = Math.atan2(y, x);
        let bearing = theta * 180 / Math.PI;
        return (bearing + 360) % 360;
    }

    // Geolocation
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
          userLat = pos.coords.latitude;
          userLon = pos.coords.longitude;
          qiblaAngle = getQiblaAngle(userLat, userLon);
          document.getElementById('qiblaAngle').textContent =
            "Угол к Кибле (от северного направления): " + qiblaAngle.toFixed(1) + "°";
          document.getElementById('status').textContent = "Совместите стрелку с направлением 'Север' на вашем устройстве.";
          updateCompass(0);

          // Получить времена молитв
          fetch(`https://api.aladhan.com/v1/timings?latitude=${userLat}&longitude=${userLon}&method=2`)
            .then(r => r.json()).then(data => {
              let t = data.data.timings;
              let html = "<b>Время намаза на сегодня:</b><br><pre>";
              ['Fajr','Sunrise','Dhuhr','Asr','Maghrib','Isha'].forEach(p => {
                html += p + ' : ' + t[p] + "\n";
              });
              html += "</pre>";
              document.getElementById('prayer-times').innerHTML = html;
            });
      }, err => {
        document.getElementById('status').textContent = "Ошибка получения местоположения.";
      });
    } else {
      document.getElementById('status').textContent = "Ваш браузер не поддерживает геолокацию.";
    }

    /** Компас на телефонах и orient-API */
    function updateCompass(alpha) {
      // alpha = направление устройства относительно географического севера (в градусах)
      // Qibla angle = угол от севера по часовой стрелке
      let angle = qiblaAngle - alpha;
      document.getElementById('arrow').style.transform =
        `translate(-50%, -100%) rotate(${angle}deg)`;
    }

    if (window.DeviceOrientationEvent) {
      window.addEventListener("deviceorientationabsolute", ev => {
        let a = ev.alpha;
        if (typeof a !== 'undefined') updateCompass(a);
      }, true);

      window.addEventListener("deviceorientation", ev => {
        // Fallback for some browsers
        let a = ev.alpha;
        if (typeof a !== 'undefined') updateCompass(a);
      }, true);
    }
  </script>
</body>
</html>
